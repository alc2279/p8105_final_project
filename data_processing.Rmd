---
title: "tudy"
author: "JiyueQin"
date: "November 19, 2018"
output: github_document
---


Risk factors that we're interested in:: (15 total)

* ACCESS2: Current lack of health insurance among adults aged 18<89><db><d2>64 Years
* BINGE: Binge drinking among adults aged >=18 Year
* BPHIGH: High blood pressure among adults aged >=18 Year
* BPMED: Taking medicine for high blood pressure control among adults aged >=18 Years with high blood pressure
* OBESITY: Obesity among adults aged >=18 Years
* CHECKUP: Visits to doctor for routine checkup within the past Year among adults aged >=18 Years
* CHOLSCREEN: Cholesterol screening among adults aged >=18 Years
* CSMOKING: Current smoking among adults aged >=18 Years
* DIABETES: Diagnosed diabetes among adults aged >=18 Years
* HIGHCHOL: High cholesterol among adults aged >=18 Years who have been screened in the past 5 Years
* KIDNEY: Chronic kidney disease among adults aged >=18 Years
* LPA: No leisure-time physical activity among adults aged >=18 Years
* MHLTH: Mental health not good for >=14 days among adults aged >=18 Years
* PHLTH: Physical health not good for >=14 days among adults aged >=18 Years
* SLEEP: Sleeping less than 7 hours among adults aged >=18 Years


Outcomes that we're interested in:: (2 total)

* CHD: Coronary heart disease among adults aged >=18 Years
* STROKE: Stroke among adults aged >=18 Years




```{r, include=FALSE}
library(stringr)
library(purrr)
library(viridis)
library(ggrepel)
library(data.table)
library(ggmap)
library(lubridate)
library(plotly)
```

## load the data 
```{r cache = TRUE}
data = read_csv("https://data.cdc.gov/api/views/6vp6-wxuq/rows.csv?accessType=DOWNLOAD")
```


```{r cache = TRUE}
cvrisk_url = "https://data.cdc.gov/api/views/6vp6-wxuq/rows.csv?accessType=DOWNLOAD"

## Read in data from github
cvrisk = 
  read.csv(url(cvrisk_url)) %>% 
  janitor::clean_names() %>% 
  as_tibble()
```



```{r, echo=FALSE, warning=FALSE, message=FALSE}
## Aakriti code from google doc
cvrisk %>% 
  filter(state_desc == "New York", city_name == "New York") %>% 
  filter(measure %in% c("High blood pressure among adults aged >=18 Years", 
                        "Coronary heart disease among adults aged >=18 Years"), 
         geographic_level == "Census Tract", year == 2015) %>% 
  select(unique_id, measure, data_value, population_count, geo_location) %>% 
  spread(key = measure, value = data_value) %>% 
  janitor::clean_names() %>% 
  ggplot(aes(x = high_blood_pressure_among_adults_aged_18_years, 
             y = coronary_heart_disease_among_adults_aged_18_years)) + 
  geom_point()
```



```{r}
## Aakriti code from google doc
geo_nyc_cvrisk = cvrisk %>% 
  filter(state_desc == "New York", city_name == "New York") %>% 
  filter(measure %in% c("High blood pressure among adults aged >=18 Years", 
                        "Coronary heart disease among adults aged >=18 Years"), 
         geographic_level == "Census Tract", year == 2015) %>% 
  select(unique_id, measure, data_value, population_count, geo_location) %>% 
  spread(key = measure, value = data_value) %>% 
  janitor::clean_names() %>%
  separate(geo_location, into = c("latitude", "longitude"), sep = ",") %>% 
  mutate(latitude = str_replace(latitude, "\\(", ""),
         longitude = str_replace(longitude, "\\)", ""))

```


```{r, eval = FALSE}
## Annie eda - this is all exploratory, for final clean dataset code, look at next data chunk
nyc_cvrisk = 
  cvrisk %>% 
  filter(state_desc == "New York", city_name == "New York")

nyc_cvrisk %>% 
  count(geographic_level)

nyc_cvrisk %>% 
  count(data_value_type)

## filter just to Census Tract
nyc_cvrisk = 
  nyc_cvrisk %>% 
  filter(geographic_level == "Census Tract")


nyc_cvrisk %>% 
  count(data_source)

nyc_cvrisk %>% 
  group_by(measure, measure_id, short_question_text) %>% 
  count() %>% View()

## one to one relationship between all three variables; only keeping measure_id

##create lookup table for measusres

cvrisk_measure_lookup = 
  cvrisk %>% 
  group_by(measure, measure_id, short_question_text) %>% 
  count()

# look at missing values

skimr::skim(nyc_cvrisk)

## 591 missing values in data_value, high_confidence_limit and low_confidence_limit
## take a deeper dive into these

nyc_cvrisk %>% 
  filter(is.na(data_value), is.na(high_confidence_limit), is.na(low_confidence_limit)) %>% 
  count(data_value_footnote)

## For all missing data values, footnote = Estimates suppressed for population less than 50

nyc_cvrisk %>% 
  filter(is.na(data_value), is.na(high_confidence_limit), is.na(low_confidence_limit)) %>% 
  count(population_count)

##for all missing values, population counts are less than 50, as the footnote says

##removing all of the null values, just to make things easier for now
nyc_cvrisk =
  nyc_cvrisk %>% 
  filter(!is.na(data_value)) %>% 
  select(year, geo_location, geo_location, population_count, measure_id, data_value) %>% 
  janitor::clean_names()

nyc_cvrisk %>% 
  group_by(year, geo_location) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  select(n) %>% 
  group_by(n) %>% 
  count()

##each geo_location/year combination has either 8 or 20 measures associated with it (there are 7 that have less than 8 measures)

## lets look at by year
nyc_cvrisk %>% 
  group_by(year, geo_location) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  select(year, n) %>% 
  group_by(year, n) %>% 
  count()




## all 2015 data has 20 measures; 2014 data has 8 or less measures

## let's get a breakdown of measures by year

nyc_cvrisk %>% 
  filter(year == 2015) %>% 
  count(measure_id)

nyc_cvrisk %>% 
  filter(year == 2014) %>% 
  count(measure_id)

## THIS IS AN ISSUE:
## 2015 and 2014 do not have all 28 measures; 2015 has 20 and 2014 has 8
## there is no overlap between the risk factors from both of the years
## because 2015 has more risk factors and only one of the risk factors only included in 2014 
## is on the list of risk factors that we are interested in looking at, I am going to remove
## 2014 data

nyc_cvrisk_2015 = 
  nyc_cvrisk %>% 
  filter(year == 2015) %>% 
  select(-year)

nyc_cvrisk_2015 %>% 
  count(geo_location) %>% 
  arrange(desc(n))

## all geo_locations have 20 measures

## split up lat/long

nyc_cvrisk_2015 = 
  nyc_cvrisk_2015 %>% 
  separate(geo_location, into = c("latitude", "longitude"), sep = ",") %>% 
  mutate(latitude = str_replace(latitude, "\\(", ""),
         longitude = str_replace(longitude, "\\)", ""))

## only select risk factors and outcomes we're interested in:

nyc_cvrisk_2015 =
  nyc_cvrisk_2015 %>% 
  filter(measure_id %in% c("ACCESS2", "BINGE", "BPHIGH", "BPMED", "OBESITY", "CHECKUP", 
                         "CHOLSCREEN", "CSMOKING", "DIABETES", "HIGHCHOL", "KIDNEY", 
                         "LPA", "MHLTH", "PHLTH", "SLEEP", "CHD", "STROKE"))
  


## checking rules for larger dataset

## lets look at by year
cvrisk %>% 
  group_by(year, geo_location) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  select(year, n) %>% 
  group_by(year, n) %>% 
  count()

cvrisk %>% 
  filter(year == 2015) %>% 
  count(measure_id)

cvrisk %>% 
  filter(year == 2014) %>% 
  count(measure_id)

## same trends for the entire dataset

```


```{r cache = TRUE}
cvrisk_url = "https://data.cdc.gov/api/views/6vp6-wxuq/rows.csv?accessType=DOWNLOAD"

## Read in data from github
cvrisk = 
  read.csv(url(cvrisk_url)) %>% 
  janitor::clean_names() %>% 
  as_tibble()
```

```{r}
## Annie EDA - final set of tidying data

## create lookup table for measures and their meaning



cvrisk_measure_lookup = 
  cvrisk %>% 
  group_by(measure, measure_id, short_question_text, year) %>% 
  count() %>% 
  arrange(year, measure_id)


## clean up nyc datset (only include 2015 data, and remove missing values)

nyc_cvrisk_2015 = 
  cvrisk %>% 
  filter(state_desc == "New York", city_name == "New York",
         geographic_level == "Census Tract",
         !is.na(data_value),
         year == 2016,
         measure_id %in% c("ACCESS2", "BINGE", "BPHIGH", "BPMED", "OBESITY", "CHECKUP", 
                         "CHOLSCREEN", "CSMOKING", "DIABETES", "HIGHCHOL", "KIDNEY", 
                         "LPA", "MHLTH", "PHLTH", "SLEEP", "CHD", "STROKE")) %>% 
  separate(geo_location, into = c("latitude", "longitude"), sep = ",") %>% 
  mutate(latitude = str_replace(latitude, "\\(", ""),
         longitude = str_replace(longitude, "\\)", "")) %>% 
  select(unique_id, latitude, longitude, population_count, measure_id, data_value)

cvrisk %>% 
  count(measure_id, year) %>% View()

nyc_cvrisk_2015_wide = 
  nyc_cvrisk_2015 %>% 
  spread(key = measure_id, value = data_value) %>% 
  janitor::clean_names()


nyc_cvrisk_2015 %>%
  ggplot(aes(x = measure_id, y = data_value)) + 
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))


## clean up full datset (only include 2015 data, and remove missing values)
cvrisk_2015 = 
  cvrisk %>% 
  filter(geographic_level == "Census Tract",
         !is.na(data_value),
         year == 2016,
         measure_id %in% c("ACCESS2", "BINGE", "BPHIGH", "BPMED", "OBESITY", "CHECKUP", 
                         "CHOLSCREEN", "CSMOKING", "DIABETES", "HIGHCHOL", "KIDNEY", 
                         "LPA", "MHLTH", "PHLTH", "SLEEP", "CHD", "STROKE")) %>% 
  separate(geo_location, into = c("latitude", "longitude"), sep = ",") %>% 
  mutate(latitude = str_replace(latitude, "\\(", ""),
         longitude = str_replace(longitude, "\\)", "")) %>% 
  select(unique_id, latitude, longitude, population_count, measure_id, data_value)

## spread measure_ids
cvrisk_2015_wide = 
  cvrisk_2015 %>% 
  spread(key = measure_id, value = data_value) %>% 
  janitor::clean_names()



cvrisk_2015 %>%
  ggplot(aes(x = measure_id, y = data_value)) + 
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```


Exploratory -- plotting each outcome by each risk factor
```{r}

## nyc plots, each risk factor x chd
nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = access2, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = binge, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = bphigh, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = bpmed, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = checkup, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = cholscreen, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = csmoking, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = diabetes, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = highchol, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = kidney, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = lpa, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = mhlth, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = obesity, y = chd)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = phlth, y = chd)) + 
  geom_point()



## nyc plots, each risk factor x stroke


nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = access2, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = binge, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = bphigh, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = bpmed, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = checkup, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = cholscreen, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = csmoking, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = diabetes, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = highchol, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = kidney, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = lpa, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = mhlth, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = obesity, y = stroke)) + 
  geom_point()

nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = phlth, y = stroke)) + 
  geom_point()


```

Correlation between risk factors/outcomes
```{r}
nyc_cvrisk_2015_wide %>% 
  select(access2:stroke) %>% 
  cor() %>% 
  View()

## install.packages("corrplot")
library(corrplot)

nyc_cvrisk_2015_wide %>% 
  select(access2:stroke) %>% 
  cor()%>%
  corrplot(., method="circle")

```

```{r}
library(patchwork)
library(tidyverse)

cvrisk %>% count(measure_id, year) %>% View()

access2_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = access2, y = chd)) + 
  geom_point()

binge_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = binge, y = chd)) + 
  geom_point()

bphigh_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = bphigh, y = chd)) + 
  geom_point()

bpmed_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = bpmed, y = chd)) + 
  geom_point()

checkup_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = checkup, y = chd)) + 
  geom_point()

cholscreen_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = cholscreen, y = chd)) + 
  geom_point()

csmoking_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = csmoking, y = chd)) + 
  geom_point()

diabetes_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = diabetes, y = chd)) + 
  geom_point()

highchol_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = highchol, y = chd)) + 
  geom_point()

kidney_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = kidney, y = chd)) + 
  geom_point()

lpa_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = lpa, y = chd)) + 
  geom_point()

mhlth_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = mhlth, y = chd)) + 
  geom_point()

obesity_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = obesity, y = chd)) + 
  geom_point()

phlth_plot = nyc_cvrisk_2015_wide %>% 
  ggplot(aes(x = phlth, y = chd)) + 
  geom_point()


##internal
(phlth_plot + obesity_plot + mhlth_plot + kidney_plot) / 
  (highchol_plot + diabetes_plot+ bphigh_plot)

##external
(lpa_plot + csmoking_plot + cholscreen_plot + checkup_plot) / 
  (bpmed_plot + binge_plot + access2_plot)

##total
(phlth_plot + obesity_plot + mhlth_plot + lpa_plot) / 
  (kidney_plot + highchol_plot + diabetes_plot  + csmoking_plot) / 
  (cholscreen_plot + checkup_plot + bpmed_plot + bphigh_plot) / 
  (binge_plot + access2_plot)


cvrisk = read_csv(file = "./raw_data/500_Cities__Local_Data_for_Better_Health__2018_release.csv") %>% 
    janitor::clean_names()



```

Heat maps of the outcome (CHD) and covariates

Top 10 cities with coronary heart disease (external factors)

```{r}

top = nyc_cvrisk%>%
  group_by( city_name)%>%
  summarize(Outcome = median(coronary_heart_disease),
            Checkup = median(annual_checkup),
            Cholesterol_Screen = median(cholesterol_screening),
            Smoking = median(current_smoking),
            Insurance = median(health_insurance),
            Inactivity = median(physical_inactivity),
            Binge_Drinking = median(binge_drinking))%>%
  arrange(desc(Outcome))%>%
  head(10)

row.names(top) = top$city_name

top_matrix = top%>%select(-city_name)%>%data.matrix(top) 

levelplot(top_matrix, col.regions=heat.colors, colorkey=list(space="right"),
          xlab = "", ylab = "", main = "Top 10 Cities with Coronary Heart Disease (External Factors)")
```


Bottom 10 cities with coronary heart disease (external factors)

```{r}

bottom = nyc_cvrisk%>%
  group_by( city_name)%>%
  summarize(Outcome = median(coronary_heart_disease),
            Checkup = median(annual_checkup),
            Cholesterol_Screen = median(cholesterol_screening),
            Smoking = median(current_smoking),
            Insurance = median(health_insurance),
            Inactivity = median(physical_inactivity),
            Binge_Drinking = median(binge_drinking))%>%
  filter(Outcome != "NA")%>%
  arrange(Outcome)%>%
  head(10)

row.names(bottom) = bottom$city_name

bottom_matrix = bottom%>%select(-city_name)%>%data.matrix(bottom) 

library(lattice)
levelplot(bottom_matrix, col.regions=heat.colors, colorkey=list(space="right"),
          xlab = "", ylab = "", main = "Bottom 10 Cities with Coronary Heart Disease (External Factors)")

```


Top 10 cities with coronary heart disease (internal factors)

```{r}

top = nyc_cvrisk%>%
  group_by( city_name)%>%
  summarize(Outcome = median(coronary_heart_disease),
            Arthritis = median(arthritis),
            Kidney_Disease = median(chronic_kidney_disease),
            COPD = median(copd),
            Diabetes = median(diabetes),
            High_Blood_Pressure = median(high_blood_pressure),
            High_Cholesterol = median(high_cholesterol),
            Stroke = median(stroke))%>%
  arrange(desc(Outcome))%>%
  head(10)

row.names(top) = top$city_name

top_matrix = top%>%select(-city_name)%>%data.matrix(top) 

levelplot(top_matrix, col.regions=heat.colors, colorkey=list(space="right"),
          xlab = "", ylab = "", main = "Top 10 Cities with Coronary Heart Disease (Internal Factors)")
```


Bottom 10 cities with coronary heart disease (internal factors)

```{r}

bottom = nyc_cvrisk%>%
  group_by( city_name)%>%
  summarize(Outcome = median(coronary_heart_disease),
            Arthritis = median(arthritis),
            Kidney_Disease = median(chronic_kidney_disease),
            COPD = median(copd),
            Diabetes = median(diabetes),
            High_Blood_Pressure = median(high_blood_pressure),
            High_Cholesterol = median(high_cholesterol),
            Stroke = median(stroke))%>%
  filter(Outcome != "NA")%>%
  arrange(Outcome)%>%
  head(10)

row.names(bottom) = bottom$city_name

bottom_matrix = bottom%>%select(-city_name)%>%data.matrix(bottom) 

library(lattice)
levelplot(bottom_matrix, col.regions=heat.colors, colorkey=list(space="right"),
          xlab = "", ylab = "", main = "Bottom 10 Cities with Coronary Heart Disease (Internal Factors)")

```

It is difficult to visually see the relationships between the variables (even when there is a high correlation) because the range in each variable is fairly small
